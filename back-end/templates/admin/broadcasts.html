{% extends "admin/base.html" %}

{% block title %}Telegram —Ä–∞—Å—Å—ã–ª–∫–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_icon %}fas fa-paper-plane{% endblock %}

{% block content %}
<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ broadcast_stats.total_sent or 0 }}</div>
                <div class="metric-label">–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ broadcast_stats.today_sent or 0 }}</div>
                <div class="metric-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ broadcast_stats.success_rate or 0 }}%</div>
                <div class="metric-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ user_stats.total_users or 0 }}</div>
                <div class="metric-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
        </div>
    </div>
</div>

<!-- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h5>
            </div>
            <div class="card-body">
                <form id="broadcastForm">
                    <div class="row">
                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ -->
                        <div class="col-lg-4">
                            <h6><i class="fas fa-users"></i> –ê—É–¥–∏—Ç–æ—Ä–∏—è</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å:</label>
                                <select class="form-select" id="targetCriteria" onchange="updateUserCount()">
                                    <option value="all">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ({{ user_stats.total_users or 0 }})</option>
                                    <option value="paid">–¢–æ–ª—å–∫–æ –ø–ª–∞—Ç–Ω—ã–º ({{ user_stats.paid_users or 0 }})</option>
                                    <option value="free">–¢–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º ({{ user_stats.free_users or 0 }})</option>
                                    <option value="selected">–í—ã–±—Ä–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                                </select>
                            </div>
                            
                            <div class="mb-3" id="selectedUsersBlock" style="display: none;">
                                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</label>
                                <select class="form-select" id="selectedUsers" multiple size="8">
                                    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                                </select>
                                <small class="text-muted">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞</small>
                            </div>
                            
                            <div class="alert alert-info">
                                <strong>–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> <span id="recipientCount">{{ user_stats.total_users or 0 }}</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏:</label>
                                <select class="form-select" id="delaySeconds">
                                    <option value="0.1">0.1 —Å–µ–∫ (–±—ã—Å—Ç—Ä–æ)</option>
                                    <option value="0.5" selected>0.5 —Å–µ–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                                    <option value="1">1 —Å–µ–∫ (–º–µ–¥–ª–µ–Ω–Ω–æ)</option>
                                    <option value="2">2 —Å–µ–∫ (–æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <div class="col-lg-8">
                            <h6><i class="fas fa-edit"></i> –°–æ–¥–µ—Ä–∂–∏–º–æ–µ</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                                <textarea class="form-control" id="messageText" rows="6" 
                                         placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...&#10;&#10;–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML —Ä–∞–∑–º–µ—Ç–∫–∞:&#10;<b>–∂–∏—Ä–Ω—ã–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>, <u>–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π</u>&#10;<a href='https://example.com'>—Å—Å—ã–ª–∫–∞</a>"></textarea>
                                <small class="text-muted">HTML —Ç–µ–≥–∏: &lt;b&gt;, &lt;i&gt;, &lt;u&gt;, &lt;a&gt;, &lt;code&gt;, &lt;pre&gt;</small>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">–§–æ—Ç–æ (URL):</label>
                                        <input type="url" class="form-control" id="photoUrl" 
                                               placeholder="https://example.com/image.jpg">
                                        <small class="text-muted">–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">–í–∏–¥–µ–æ (URL):</label>
                                        <input type="url" class="form-control" id="videoUrl" 
                                               placeholder="https://example.com/video.mp4">
                                        <small class="text-muted">–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏:</label>
                                        <input type="text" class="form-control" id="buttonText" 
                                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">–°—Å—ã–ª–∫–∞ –∫–Ω–æ–ø–∫–∏:</label>
                                        <input type="url" class="form-control" id="buttonUrl" 
                                               placeholder="https://example.com">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</h6>
                                <div class="card bg-light" id="messagePreview" style="max-width: 400px;">
                                    <div class="card-body">
                                        <div id="previewContent">
                                            <p class="text-muted">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                                        </div>
                                        <div id="previewButton" style="display: none;">
                                            <button class="btn btn-primary btn-sm">
                                                <i class="fas fa-external-link-alt"></i> <span id="previewButtonText">–ö–Ω–æ–ø–∫–∞</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="previewMessage()">
                            <i class="fas fa-eye"></i> –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <button type="submit" class="btn btn-admin btn-lg" id="sendButton">
                            <i class="fas fa-paper-plane"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ -->
<div class="row">
    <div class="col-12">
        <div class="table-container">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</h5>
                <button class="btn btn-outline-success btn-sm" onclick="refreshHistory()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            <div class="table-responsive">
                <table class="table mb-0" id="broadcastHistory">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ê—É–¥–∏—Ç–æ—Ä–∏—è</th>
                            <th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                            <th>–£—Å–ø–µ—à–Ω–æ</th>
                            <th>–û—à–∏–±–∫–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fas fa-paper-plane fa-3x mb-3 d-block"></i>
                                –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ –ø—É—Å—Ç–∞. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ -->
<div class="modal fade" id="broadcastProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-paper-plane"></i> –†–∞—Å—Å—ã–ª–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–û—Ç–ø—Ä–∞–≤–∫–∞...</span>
                    </div>
                </div>
                <p>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
                <div class="progress mb-3">
                    <div class="progress-bar" id="broadcastProgress" role="progressbar" 
                         style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <p class="text-muted" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cancelBroadcast()" disabled id="cancelButton">
                    –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedUsersList = [];
    let broadcastInProgress = false;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function updateUserCount() {
        const criteria = document.getElementById('targetCriteria').value;
        const selectedBlock = document.getElementById('selectedUsersBlock');
        const recipientCount = document.getElementById('recipientCount');
        
        if (criteria === 'selected') {
            selectedBlock.style.display = 'block';
            loadUsersList();
            recipientCount.textContent = '0 (–≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)';
        } else {
            selectedBlock.style.display = 'none';
            
            const counts = {
                'all': {{ user_stats.total_users or 0 }},
                'paid': {{ user_stats.paid_users or 0 }},
                'free': {{ user_stats.free_users or 0 }}
            };
            
            recipientCount.textContent = counts[criteria] || 0;
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    async function loadUsersList() {
        try {
            const response = await fetch('/admin/api/users/list');
            const users = await response.json();
            
            const select = document.getElementById('selectedUsers');
            select.innerHTML = '';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = `${user.display_name} (${user.profiles_count} –∑–∞–ø—Ä–æ—Å–æ–≤)`;
                if (user.has_subscription) {
                    option.textContent += ' üíé'; // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                }
                select.appendChild(option);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
            select.addEventListener('change', function() {
                const selected = Array.from(this.selectedOptions).map(opt => opt.value);
                document.getElementById('recipientCount').textContent = selected.length;
            });
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'danger');
        }
    }
    
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
    function previewMessage() {
        const text = document.getElementById('messageText').value;
        const photoUrl = document.getElementById('photoUrl').value;
        const videoUrl = document.getElementById('videoUrl').value;
        const buttonText = document.getElementById('buttonText').value;
        const buttonUrl = document.getElementById('buttonUrl').value;
        
        const previewContent = document.getElementById('previewContent');
        const previewButton = document.getElementById('previewButton');
        const previewButtonText = document.getElementById('previewButtonText');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ
        let content = '';
        if (photoUrl) {
            content += `<img src="${photoUrl}" class="img-fluid mb-2" style="max-height: 200px;">`;
        }
        if (videoUrl) {
            content += `<video controls class="img-fluid mb-2" style="max-height: 200px;"><source src="${videoUrl}"></video>`;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
        if (text) {
            content += `<p>${text.replace(/\n/g, '<br>')}</p>`;
        }
        
        previewContent.innerHTML = content || '<p class="text-muted">–¢–µ–∫—Å—Ç –Ω–µ –≤–≤–µ–¥–µ–Ω</p>';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (buttonText && buttonUrl) {
            previewButtonText.textContent = buttonText;
            previewButton.style.display = 'block';
        } else {
            previewButton.style.display = 'none';
        }
    }
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    document.getElementById('messageText').addEventListener('input', previewMessage);
    document.getElementById('photoUrl').addEventListener('input', previewMessage);
    document.getElementById('videoUrl').addEventListener('input', previewMessage);
    document.getElementById('buttonText').addEventListener('input', previewMessage);
    document.getElementById('buttonUrl').addEventListener('input', previewMessage);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
    document.getElementById('broadcastForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (broadcastInProgress) {
            showNotification('–†–∞—Å—Å—ã–ª–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è', 'warning');
            return;
        }
        
        const criteria = document.getElementById('targetCriteria').value;
        const selectedUsers = criteria === 'selected' ? 
            Array.from(document.getElementById('selectedUsers').selectedOptions).map(opt => opt.value) : [];
        
        const broadcastData = {
            target_criteria: criteria,
            selected_users: selectedUsers,
            text: document.getElementById('messageText').value,
            photo_url: document.getElementById('photoUrl').value,
            video_url: document.getElementById('videoUrl').value,
            button_text: document.getElementById('buttonText').value,
            button_url: document.getElementById('buttonUrl').value,
            delay_seconds: parseFloat(document.getElementById('delaySeconds').value)
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!broadcastData.text && !broadcastData.photo_url && !broadcastData.video_url) {
            showNotification('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ', 'warning');
            return;
        }
        
        if (criteria === 'selected' && selectedUsers.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'warning');
            return;
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        const recipientCount = document.getElementById('recipientCount').textContent.split(' ')[0];
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É ${recipientCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
            return;
        }
        
        // –ó–∞–ø—É—Å–∫ —Ä–∞—Å—Å—ã–ª–∫–∏
        broadcastInProgress = true;
        document.getElementById('sendButton').disabled = true;
        
        const progressModal = new bootstrap.Modal(document.getElementById('broadcastProgressModal'));
        progressModal.show();
        
        try {
            const response = await fetch('/admin/broadcasts/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(broadcastData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                const results = result.results;
                document.getElementById('progressText').innerHTML = `
                    <strong>–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</strong><br>
                    –£—Å–ø–µ—à–Ω–æ: ${results.success}<br>
                    –û—à–∏–±–æ–∫: ${results.failed}<br>
                    –í—Å–µ–≥–æ: ${results.total}
                `;
                
                document.getElementById('broadcastProgress').style.width = '100%';
                document.getElementById('broadcastProgress').textContent = '100%';
                document.getElementById('cancelButton').textContent = '–ó–∞–∫—Ä—ã—Ç—å';
                document.getElementById('cancelButton').disabled = false;
                
                showNotification(`–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${results.success}, –û—à–∏–±–æ–∫: ${results.failed}`, 'success');
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('broadcastForm').reset();
                updateUserCount();
                previewMessage();
                
            } else {
                throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏: ' + error.message, 'danger');
            progressModal.hide();
        } finally {
            broadcastInProgress = false;
            document.getElementById('sendButton').disabled = false;
        }
    });
    
    // –û—Ç–º–µ–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
    function cancelBroadcast() {
        bootstrap.Modal.getInstance(document.getElementById('broadcastProgressModal')).hide();
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
    function refreshHistory() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
        showNotification('–ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'info');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        updateUserCount();
        previewMessage();
    });
</script>
{% endblock %}
