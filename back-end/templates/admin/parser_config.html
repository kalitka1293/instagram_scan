{% extends "admin/base.html" %}

{% block title %}Настройки парсера - Админ панель{% endblock %}

{% block page_icon %}fas fa-cog{% endblock %}

{% block content %}

<!-- Статистика -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value" id="cookiesCount">{{ cookies|length }}</div>
                <div class="metric-label">Активных Cookies</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ timings.base_delay }}s</div>
                <div class="metric-label">Базовая задержка</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ timings.max_followers }}</div>
                <div class="metric-label">Макс. подписчиков</div>
            </div>
        </div>
    </div>
</div>

<!-- Управление Cookies -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-cookie-bite"></i> Управление Cookies</h5>
                <button class="btn btn-admin" onclick="showAddCookieModal()">
                    <i class="fas fa-plus"></i> Добавить Cookie
                </button>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong><i class="fas fa-info-circle"></i> Как это работает:</strong><br>
                    • Каждый парсинг использует следующий cookie из списка (round-robin)<br>
                    • Минимум 1 cookie обязателен для работы системы<br>
                    • Рекомендуется 3-5 cookies для оптимальной балансировки<br>
                    • Cookie должен содержать <code>sessionid</code> и <code>csrftoken</code>
                </div>

                <div id="cookiesContainer">
                    {% if cookies|length == 0 %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Нет активных cookies! Добавьте хотя бы один.
                    </div>
                    {% else %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">#</th>
                                    <th>Cookie</th>
                                    <th style="width: 200px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cookie in cookies %}
                                <tr data-index="{{ loop.index0 }}">
                                    <td>
                                        <span class="badge bg-gradient-admin">#{{ loop.index }}</span>
                                    </td>
                                    <td>
                                        <code class="cookie-preview" title="{{ cookie }}">{{ cookie[:100] }}{% if cookie|length > 100 %}...{% endif %}</code>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="editCookie({{ loop.index0 }}, '{{ cookie|replace("'", "\\'") }}')">
                                            <i class="fas fa-edit"></i> Изменить
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteCookie({{ loop.index0 }})" 
                                                {% if cookies|length <= 1 %}disabled title="Нельзя удалить последний cookie"{% endif %}>
                                            <i class="fas fa-trash"></i> Удалить
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Настройка таймингов -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Настройки таймингов и лимитов</h5>
                <button class="btn btn-outline-secondary" onclick="resetToDefaults()">
                    <i class="fas fa-undo"></i> Сбросить на значения по умолчанию
                </button>
            </div>
            <div class="card-body">
                <form id="timingsForm" onsubmit="updateTimings(event)">
                    <div class="row g-3">
                        <!-- Базовые настройки -->
                        <div class="col-12">
                            <h6 class="text-muted mb-3"><i class="fas fa-sliders-h"></i> Базовые параметры</h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Базовая задержка (сек)</label>
                            <input type="number" class="form-control" name="base_delay" step="0.1" min="0" value="{{ timings.base_delay }}" required>
                            <small class="form-text text-muted">Основная задержка между запросами</small>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Таймаут (сек)</label>
                            <input type="number" class="form-control" name="timeout" min="1" value="{{ timings.timeout }}" required>
                            <small class="form-text text-muted">Максимальное время ожидания ответа</small>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Макс. попыток</label>
                            <input type="number" class="form-control" name="max_retries" min="1" value="{{ timings.max_retries }}" required>
                            <small class="form-text text-muted">Количество повторных попыток</small>
                        </div>

                        <!-- Лимиты парсинга -->
                        <div class="col-12 mt-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-layer-group"></i> Лимиты парсинга</h6>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Размер страницы</label>
                            <input type="number" class="form-control" name="page_size" min="1" max="50" value="{{ timings.page_size }}" required>
                            <small class="form-text text-muted">Элементов на одну страницу</small>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Макс. подписчиков</label>
                            <input type="number" class="form-control" name="max_followers" min="1" value="{{ timings.max_followers }}" required>
                            <small class="form-text text-muted">Максимум подписчиков для парсинга</small>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Макс. подписок</label>
                            <input type="number" class="form-control" name="max_followings" min="1" value="{{ timings.max_followings }}" required>
                            <small class="form-text text-muted">Максимум подписок для парсинга</small>
                        </div>

                        <!-- Случайные задержки -->
                        <div class="col-12 mt-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-random"></i> Случайные задержки (Jitter)</h6>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Jitter мин (сек)</label>
                            <input type="number" class="form-control" name="jitter_min" step="0.1" min="0" value="{{ timings.jitter_min }}" required>
                            <small class="form-text text-muted">Минимальная случайная задержка</small>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Jitter макс (сек)</label>
                            <input type="number" class="form-control" name="jitter_max" step="0.1" min="0" value="{{ timings.jitter_max }}" required>
                            <small class="form-text text-muted">Максимальная случайная задержка</small>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Доп. задержка мин (сек)</label>
                            <input type="number" class="form-control" name="additional_delay_min" step="0.1" min="0" value="{{ timings.additional_delay_min }}" required>
                            <small class="form-text text-muted">Минимальная дополнительная задержка</small>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Доп. задержка макс (сек)</label>
                            <input type="number" class="form-control" name="additional_delay_max" step="0.1" min="0" value="{{ timings.additional_delay_max }}" required>
                            <small class="form-text text-muted">Максимальная дополнительная задержка</small>
                        </div>

                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-admin btn-lg">
                                <i class="fas fa-save"></i> Сохранить настройки таймингов
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления/редактирования cookie -->
<div class="modal fade" id="cookieModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Добавить Cookie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cookieForm" onsubmit="saveCookie(event)">
                    <div class="mb-3">
                        <label class="form-label">Cookie строка</label>
                        <textarea class="form-control" id="cookieInput" name="cookie" rows="4" required 
                                  placeholder="ps_n=1;datr=...;sessionid=..."></textarea>
                        <small class="form-text text-muted">Вставьте полную строку cookie из браузера</small>
                    </div>
                    <div class="alert alert-info">
                        <strong><i class="fas fa-lightbulb"></i> Как получить cookie:</strong><br>
                        1. Откройте Instagram в браузере и авторизуйтесь<br>
                        2. Нажмите F12 → Application → Cookies → instagram.com<br>
                        3. Скопируйте все cookies в формате: name1=value1;name2=value2
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-admin">
                            <i class="fas fa-save"></i> Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.cookie-preview {
    display: block;
    max-width: 600px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    background: #f8f9fa;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-family: 'Courier New', monospace;
}

.bg-gradient-admin {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
}
</style>

<script>
let editingIndex = null;
let cookieModalInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    const cookieModalEl = document.getElementById('cookieModal');
    if (cookieModalEl) {
        cookieModalInstance = new bootstrap.Modal(cookieModalEl);
    }
});

function showAlert(message, type = 'success') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-fluid');
    const alertDiv = document.createElement('div');
    alertDiv.innerHTML = alertHtml;
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function showAddCookieModal() {
    editingIndex = null;
    document.getElementById('modalTitle').textContent = 'Добавить Cookie';
    document.getElementById('cookieInput').value = '';
    cookieModalInstance.show();
}

function editCookie(index, cookie) {
    editingIndex = index;
    document.getElementById('modalTitle').textContent = 'Редактировать Cookie';
    document.getElementById('cookieInput').value = cookie;
    cookieModalInstance.show();
}

async function saveCookie(event) {
    event.preventDefault();
    const cookie = document.getElementById('cookieInput').value.trim();
    
    try {
        let response;
        if (editingIndex !== null) {
            response = await fetch(`/admin/api/parser-config/cookies/${editingIndex}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cookie})
            });
        } else {
            response = await fetch('/admin/api/parser-config/cookies/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cookie})
            });
        }

        const result = await response.json();
        if (result.success) {
            showAlert(result.message, 'success');
            cookieModalInstance.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}

async function deleteCookie(index) {
    if (!confirm('Вы уверены, что хотите удалить этот cookie?')) return;

    try {
        const response = await fetch(`/admin/api/parser-config/cookies/${index}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}

async function updateTimings(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const timings = {};

    for (let [key, value] of formData.entries()) {
        timings[key] = value;
    }

    try {
        const response = await fetch('/admin/api/parser-config/timings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({timings})
        });
        const result = await response.json();
        if (result.success) {
            showAlert(result.message, 'success');
        } else {
            showAlert(result.message || 'Ошибка обновления', 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}

async function resetToDefaults() {
    if (!confirm('Вы уверены, что хотите сбросить все настройки на значения по умолчанию?')) return;

    try {
        const response = await fetch('/admin/api/parser-config/reset', {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}
</script>

{% endblock %}
