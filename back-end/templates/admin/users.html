{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_icon %}fas fa-users{% endblock %}

{% block content %}
<!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3" id="searchForm">
                    <div class="col-lg-5">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" name="search" value="{{ search }}" 
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ User ID..." id="searchInput">
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <select class="form-select" name="page_size" onchange="this.form.submit()">
                            <option value="25" {% if page_size == 25 %}selected{% endif %}>25 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                            <option value="50" {% if page_size == 50 %}selected{% endif %}>50 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                            <option value="100" {% if page_size == 100 %}selected{% endif %}>100 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                            <option value="250" {% if page_size == 250 %}selected{% endif %}>250 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <select class="form-select" name="sort" onchange="this.form.submit()">
                            <option value="created_desc" {% if sort == 'created_desc' %}selected{% endif %}>–ù–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                            <option value="created_asc" {% if sort == 'created_asc' %}selected{% endif %}>–°—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                            <option value="active_desc" {% if sort == 'active_desc' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                            <option value="requests_desc" {% if sort == 'requests_desc' %}selected{% endif %}>–ü–æ –∑–∞–ø—Ä–æ—Å–∞–º</option>
                        </select>
                    </div>
                    <div class="col-lg-3">
                        <div class="btn-group w-100">
                            <button type="submit" class="btn btn-admin">
                                <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
                            </button>
                            <a href="/admin/users" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> –°–±—Ä–æ—Å–∏—Ç—å
                            </a>
                            <button type="button" class="btn btn-outline-info" onclick="toggleAdvancedSearch()">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                <div class="mt-3" id="advancedFilters" style="display: none;">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏:</label>
                            <select class="form-select" name="subscription_status">
                                <option value="">–í—Å–µ</option>
                                <option value="active">–ê–∫—Ç–∏–≤–Ω–∞—è</option>
                                <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                            <select class="form-select" name="user_type">
                                <option value="">–í—Å–µ</option>
                                <option value="paid">–ü–ª–∞—Ç–Ω—ã–µ</option>
                                <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</label>
                            <select class="form-select" name="activity">
                                <option value="">–í—Å–µ</option>
                                <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                                <option value="week">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</option>
                                <option value="month">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤:</label>
                            <select class="form-select" name="requests_filter">
                                <option value="">–í—Å–µ</option>
                                <option value="0">–ë–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                                <option value="1-5">1-5 –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                                <option value="6-20">6-20 –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                                <option value="20+">20+ –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ users|length }}</div>
                <div class="metric-label">–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ users|selectattr("has_active_subscription")|list|length }}</div>
                <div class="metric-label">–° –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ users|sum(attribute="profiles_count") }}</div>
                <div class="metric-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ (users|sum(attribute="profiles_count") / (users|length or 1))|round(1) }}</div>
                <div class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="row mb-3" id="bulkActions" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center justify-content-between">
            <div>
                <i class="fas fa-check-square me-2"></i>
                –í—ã–±—Ä–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong id="selectedCount">0</strong>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="bulkChangeTariff()">
                    <i class="fas fa-crown"></i> –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="bulkToggleStatus()">
                    <i class="fas fa-user-slash"></i> –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="bulkExport()">
                    <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div class="table-container">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
        <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" onclick="exportUsers()">
                <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="refreshUsers()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table mb-0" id="usersTable">
            <thead>
                <tr>
                    <th width="20%">User ID</th>
                    <th width="15%">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                    <th width="10%">–ó–∞–ø—Ä–æ—Å—ã</th>
                    <th width="15%">–ü–æ–¥–ø–∏—Å–∫–∞</th>
                    <th width="15%">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                    <th width="10%">–°—Ç–∞—Ç—É—Å</th>
                    <th width="15%">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user_data in users %}
                <tr data-user-id="{{ user_data.user.user_id }}">
                    <td>
                        <strong>{{ user_data.display_name }}</strong>
                        {% if user_data.ig_username != user_data.user.user_id %}
                        <br><small class="text-muted">ID: {{ user_data.user.user_id }}</small>
                        {% endif %}
                        {% if user_data.user.is_paid %}
                        <span class="badge bg-success ms-1">üíé PAID</span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">
                            {{ user_data.user.created_at.strftime('%d.%m.%Y') if user_data.user.created_at else '-' }}
                        </small>
                    </td>
                    <td>
                        <span class="badge bg-primary">{{ user_data.profiles_count }}</span>
                        {% if user_data.user.remaining_requests is not none and user_data.user.remaining_requests > 0 %}
                        <br><small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å: {{ user_data.user.remaining_requests }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if user_data.has_active_subscription %}
                        <span class="status-badge status-active">{{ user_data.tariff_name }}</span>
                        {% if user_data.subscription_end %}
                        <br><small class="text-muted">–¥–æ {{ user_data.subscription_end.strftime('%d.%m.%Y') }}</small>
                        {% endif %}
                        {% else %}
                        <span class="status-badge">–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user_data.user.last_login %}
                        <small class="text-muted">{{ user_data.user.last_login.strftime('%d.%m.%Y %H:%M') }}</small>
                        {% else %}
                        <small class="text-muted">–ù–∏–∫–æ–≥–¥–∞</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if user_data.user.is_active %}
                        <span class="status-badge status-active">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                        <span class="status-badge status-failed">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editUser('{{ user_data.user.user_id }}')" 
                                    title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="changeTariff('{{ user_data.user.user_id }}')" 
                                    title="–ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ">
                                <i class="fas fa-crown"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteUser('{{ user_data.user.user_id }}')" 
                                    title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                
                {% if not users %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-users fa-3x mb-3 d-block"></i>
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <div class="p-3 border-top bg-light">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3">
                        –ü–æ–∫–∞–∑–∞–Ω–æ {{ ((current_page - 1) * 50 + 1) }}-{{ min(current_page * 50, users|length + (current_page - 1) * 50) }} 
                        –∏–∑ –ø—Ä–∏–º–µ—Ä–Ω–æ {{ total_pages * 50 }} –∑–∞–ø–∏—Å–µ–π
                    </span>
                </div>
            </div>
            
            <div class="col-md-4 text-center">
                <nav>
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page > 3 %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{{ '&search=' + search if search }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}" title="–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ current_page - 1 }}{{ '&search=' + search if search }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
                        {% for page_num in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
                        {% if page_num == current_page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_num }}{{ '&search=' + search if search }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}">{{ page_num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ current_page + 1 }}{{ '&search=' + search if search }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}" title="–°–ª–µ–¥—É—é—â–∞—è">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page < total_pages - 2 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ total_pages }}{{ '&search=' + search if search }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}" title="–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            
            <div class="col-md-4 text-end">
                <div class="d-flex align-items-center justify-content-end">
                    <span class="text-muted me-2">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞:</span>
                    <input type="number" class="form-control form-control-sm" style="width: 70px;" 
                           min="1" max="{{ total_pages }}" value="{{ current_page }}" 
                           onchange="goToPage(this.value)" placeholder="‚Ññ">
                    <span class="text-muted ms-2">–∏–∑ {{ total_pages }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã —Ç–∞—Ä–∏—Ñ–∞ -->
<div class="modal fade" id="changeTariffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-crown"></i> –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changeTariffForm">
                <div class="modal-body">
                    <input type="hidden" id="changeTariffUserId">
                    <div class="mb-3">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ:</label>
                        <select class="form-select" id="newTariffId" required>
                            <option value="">–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏</option>
                            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-admin">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">User ID</label>
                                <input type="text" class="form-control" id="editUserIdDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="form-select" id="editUserActive" required>
                                    <option value="true">–ê–∫—Ç–∏–≤–µ–Ω</option>
                                    <option value="false">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–¢–∞—Ä–∏—Ñ</label>
                                <select class="form-select" id="editUserTariff">
                                    <option value="">–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏</option>
                                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã</label>
                                <input type="number" class="form-control" id="editUserRequests" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—Å–∫–∏</label>
                                <input type="datetime-local" class="form-control" id="editUserSubStart">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</label>
                                <input type="datetime-local" class="form-control" id="editUserSubEnd">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editUserPaid">
                            <label class="form-check-label" for="editUserPaid">
                                –ü–ª–∞—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                            </label>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        –ò–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-admin">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    async function loadTariffs() {
        try {
            const response = await fetch('/api/tariffs');
            const tariffs = await response.json();
            
            const select = document.getElementById('newTariffId');
            tariffs.forEach(tariff => {
                const option = document.createElement('option');
                option.value = tariff.id;
                option.textContent = `${tariff.name} (‚ÇΩ${tariff.price})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤:', error);
        }
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
    function changeTariff(userId) {
        document.getElementById('changeTariffUserId').value = userId;
        new bootstrap.Modal(document.getElementById('changeTariffModal')).show();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã —Ç–∞—Ä–∏—Ñ–∞
    document.getElementById('changeTariffForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userId = document.getElementById('changeTariffUserId').value;
        const tariffId = document.getElementById('newTariffId').value;
        
        try {
            const formData = new FormData();
            formData.append('tariff_id', tariffId);
            
            const response = await fetch(`/admin/users/${userId}/tariff`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–¢–∞—Ä–∏—Ñ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('changeTariffModal')).hide();
                location.reload();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞', 'danger');
        }
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function deleteUser(userId) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/users/${userId}/delete`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!', 'success');
                document.querySelector(`tr[data-user-id="${userId}"]`).remove();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'danger');
        }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function editUser(userId) {
        try {
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ
            const row = document.querySelector(`tr[data-user-id="${userId}"]`);
            const cells = row.querySelectorAll('td');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserIdDisplay').value = userId;
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const response = await fetch(`/admin/users/${userId}/details`);
            if (response.ok) {
                const userData = await response.json();
                
                document.getElementById('editUserActive').value = userData.is_active ? 'true' : 'false';
                document.getElementById('editUserTariff').value = userData.current_tariff_id || '';
                document.getElementById('editUserRequests').value = userData.remaining_requests || 0;
                document.getElementById('editUserPaid').checked = userData.is_paid || false;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –¥–ª—è datetime-local
                if (userData.subscription_start) {
                    document.getElementById('editUserSubStart').value = formatDateTimeLocal(userData.subscription_start);
                }
                if (userData.subscription_end) {
                    document.getElementById('editUserSubEnd').value = formatDateTimeLocal(userData.subscription_end);
                }
            }
            
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'danger');
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userId = document.getElementById('editUserId').value;
        const formData = {
            is_active: document.getElementById('editUserActive').value === 'true',
            current_tariff_id: document.getElementById('editUserTariff').value || null,
            remaining_requests: parseInt(document.getElementById('editUserRequests').value) || 0,
            is_paid: document.getElementById('editUserPaid').checked,
            subscription_start: document.getElementById('editUserSubStart').value || null,
            subscription_end: document.getElementById('editUserSubEnd').value || null
        };
        
        try {
            const response = await fetch(`/admin/users/${userId}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                location.reload();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'danger');
        }
    });
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è datetime-local input
    function formatDateTimeLocal(dateString) {
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16);
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function exportUsers() {
        window.open('/admin/users/export?' + new URLSearchParams(window.location.search), '_blank');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    function refreshUsers() {
        location.reload();
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    function goToPage(pageNum) {
        if (pageNum < 1 || pageNum > {{ total_pages }}) {
            showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'warning');
            return;
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page', pageNum);
        window.location.search = urlParams.toString();
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function toggleAdvancedSearch() {
        const filters = document.getElementById('advancedFilters');
        const button = event.target.closest('button');
        
        if (filters.style.display === 'none' || filters.style.display === '') {
            filters.style.display = 'block';
            button.innerHTML = '<i class="fas fa-filter-circle-xmark"></i>';
            button.classList.remove('btn-outline-info');
            button.classList.add('btn-info');
        } else {
            filters.style.display = 'none';
            button.innerHTML = '<i class="fas fa-filter"></i>';
            button.classList.remove('btn-info');
            button.classList.add('btn-outline-info');
        }
    }
    
    // –ñ–∏–≤–æ–π –ø–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.length >= 3 || this.value.length === 0) {
                document.getElementById('searchForm').submit();
            }
        }, 500);
    });
    
    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
            return; // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ—Å–ª–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        }
        
        const currentPage = {{ current_page }};
        const totalPages = {{ total_pages }};
        
        if (e.key === 'ArrowLeft' && currentPage > 1) {
            goToPage(currentPage - 1);
        } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
            goToPage(currentPage + 1);
        } else if (e.key === 'Home') {
            goToPage(1);
        } else if (e.key === 'End') {
            goToPage(totalPages);
        }
    });
    
    // –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    function selectAllUsers() {
        const checkboxes = document.querySelectorAll('input[name="selected_users[]"]');
        const selectAll = document.getElementById('selectAllUsers');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkActions();
    }
    
    function updateBulkActions() {
        const checked = document.querySelectorAll('input[name="selected_users[]"]:checked');
        const bulkActions = document.getElementById('bulkActions');
        
        if (checked.length > 0) {
            bulkActions.style.display = 'block';
            document.getElementById('selectedCount').textContent = checked.length;
        } else {
            bulkActions.style.display = 'none';
        }
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞—Ä–∏—Ñ—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadTariffs();
        
        // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
        if (!document.querySelector('input[name="selected_users[]"]')) {
            addBulkSelectionCheckboxes();
        }
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞
    function addBulkSelectionCheckboxes() {
        // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å "–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ" –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const headerRow = document.querySelector('#usersTable thead tr');
        if (headerRow && !headerRow.querySelector('input[type="checkbox"]')) {
            const th = document.createElement('th');
            th.width = '5%';
            th.innerHTML = '<input type="checkbox" id="selectAllUsers" onchange="selectAllUsers()">';
            headerRow.insertBefore(th, headerRow.firstChild);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –≤ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É
        const rows = document.querySelectorAll('#usersTable tbody tr[data-user-id]');
        rows.forEach(row => {
            if (!row.querySelector('input[type="checkbox"]')) {
                const td = document.createElement('td');
                const userId = row.getAttribute('data-user-id');
                td.innerHTML = `<input type="checkbox" name="selected_users[]" value="${userId}" onchange="updateBulkActions()">`;
                row.insertBefore(td, row.firstChild);
            }
        });
    }
    
    // –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    function bulkChangeTariff() {
        const selected = Array.from(document.querySelectorAll('input[name="selected_users[]"]:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'warning');
            return;
        }
        showNotification(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –¥–ª—è ${selected.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }
    
    function bulkToggleStatus() {
        const selected = Array.from(document.querySelectorAll('input[name="selected_users[]"]:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'warning');
            return;
        }
        showNotification(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è ${selected.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }
    
    function bulkExport() {
        const selected = Array.from(document.querySelectorAll('input[name="selected_users[]"]:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'warning');
            return;
        }
        
        const params = new URLSearchParams();
        selected.forEach(userId => params.append('user_ids', userId));
        window.open('/admin/users/export?' + params.toString(), '_blank');
    }
    
    function bulkDelete() {
        const selected = Array.from(document.querySelectorAll('input[name="selected_users[]"]:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'warning');
            return;
        }
        
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selected.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            return;
        }
        
        showNotification(`–£–¥–∞–ª–µ–Ω–∏–µ ${selected.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
    }
</script>
{% endblock %}
