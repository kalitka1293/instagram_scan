{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ CloudPayments{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ CloudPayments</h1>
    <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</p>
</div>

<div class="subscriptions-management">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ active_subscriptions|length }}</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {{ active_subscriptions|selectattr("status", "equalto", "active")|list|length }}
            </div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {{ active_subscriptions|selectattr("status", "equalto", "paused")|list|length }}
            </div>
            <div class="stat-label">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫ -->
    <div class="subscriptions-list">
        <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
        
        {% if active_subscriptions %}
        <div class="table-responsive">
            <table class="subscriptions-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–¢–∞—Ä–∏—Ñ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂</th>
                        <th>–ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫</th>
                        <th>CloudPayments ID</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for subscription in active_subscriptions %}
                    <tr class="subscription-row" data-subscription-id="{{ subscription.id }}">
                        <td>{{ subscription.id }}</td>
                        <td>
                            <div class="user-info">
                                <strong>{{ subscription.user.telegram_username or subscription.user.first_name or subscription.user.user_id }}</strong>
                                <small>{{ subscription.user.user_id }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="tariff-info">
                                <strong>{{ subscription.tariff.name }}</strong>
                                <small>{{ subscription.tariff.price }}‚ÇΩ</small>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ subscription.status }}">
                                {% if subscription.status == 'active' %}
                                    ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞
                                {% elif subscription.status == 'paused' %}
                                    ‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                                {% else %}
                                    ‚ùå {{ subscription.status }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if subscription.next_payment_date %}
                                {{ subscription.next_payment_date.strftime('%d.%m.%Y %H:%M') }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td>
                            {% if subscription.failed_attempts > 0 %}
                                <span class="failed-attempts">{{ subscription.failed_attempts }}</span>
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {% if subscription.cloudpayments_subscription_id %}
                                <code>{{ subscription.cloudpayments_subscription_id[:10] }}...</code>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if subscription.status == 'active' %}
                                    <button class="btn btn-warning btn-sm" onclick="pauseSubscription({{ subscription.id }})">
                                        ‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                    </button>
                                {% elif subscription.status == 'paused' %}
                                    <button class="btn btn-success btn-sm" onclick="resumeSubscription({{ subscription.id }})">
                                        ‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                {% endif %}
                                
                                <button class="btn btn-danger btn-sm" onclick="cancelSubscription({{ subscription.id }})">
                                    ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-data">
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
.subscriptions-management {
    padding: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    color: #666;
    margin-top: 5px;
}

.subscriptions-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.subscriptions-table th,
.subscriptions-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.subscriptions-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.user-info strong {
    display: block;
}

.user-info small {
    color: #666;
}

.tariff-info strong {
    display: block;
}

.tariff-info small {
    color: #666;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-paused {
    background: #fff3cd;
    color: #856404;
}

.failed-attempts {
    background: #f8d7da;
    color: #721c24;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
}

.btn-sm {
    padding: 3px 8px;
    font-size: 0.75rem;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn:hover {
    opacity: 0.8;
}

.no-data {
    text-align: center;
    padding: 40px;
    color: #666;
}

.table-responsive {
    overflow-x: auto;
}

code {
    background: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: monospace;
}
</style>

<script>
async function pauseSubscription(subscriptionId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –ø–æ–¥–ø–∏—Å–∫—É?')) {
        return;
    }

    try {
        const response = await fetch(`/admin/subscriptions/${subscriptionId}/pause`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();
        
        if (result.success) {
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            location.reload();
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.message}`);
        }
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
}

async function resumeSubscription(subscriptionId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —ç—Ç—É –ø–æ–¥–ø–∏—Å–∫—É?')) {
        return;
    }

    try {
        const response = await fetch(`/admin/subscriptions/${subscriptionId}/resume`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();
        
        if (result.success) {
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            location.reload();
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.message}`);
        }
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
}

async function cancelSubscription(subscriptionId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ü–û–õ–ù–û–°–¢–¨–Æ –û–¢–ú–ï–ù–ò–¢–¨ —ç—Ç—É –ø–æ–¥–ø–∏—Å–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        return;
    }

    try {
        const response = await fetch(`/admin/subscriptions/${subscriptionId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();
        
        if (result.success) {
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
            location.reload();
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.message}`);
        }
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
}
</script>
{% endblock %}







