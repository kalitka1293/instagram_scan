{% extends "admin/base.html" %}

{% block title %}–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_icon %}fas fa-search{% endblock %}

{% block content %}
<!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3" id="profileSearchForm">
                    <div class="col-lg-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" name="search" value="{{ search }}" 
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ username..." id="profileSearchInput">
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <select class="form-select" name="status" onchange="this.form.submit()">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="completed" {% if status == 'completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                            <option value="processing" {% if status == 'processing' %}selected{% endif %}>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                            <option value="pending" {% if status == 'pending' %}selected{% endif %}>–û–∂–∏–¥–∞–Ω–∏–µ</option>
                            <option value="failed" {% if status == 'failed' %}selected{% endif %}>–û—à–∏–±–∫–∞</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <select class="form-select" name="page_size" onchange="this.form.submit()">
                            <option value="20" {% if page_size == 20 %}selected{% endif %}>20 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                            <option value="30" {% if page_size == 30 %}selected{% endif %}>30 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                            <option value="50" {% if page_size == 50 %}selected{% endif %}>50 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                            <option value="100" {% if page_size == 100 %}selected{% endif %}>100 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <select class="form-select" name="sort" onchange="this.form.submit()">
                            <option value="created_desc" {% if sort == 'created_desc' %}selected{% endif %}>–ù–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                            <option value="followers_desc" {% if sort == 'followers_desc' %}selected{% endif %}>–ü–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º</option>
                            <option value="success_desc" {% if sort == 'success_desc' %}selected{% endif %}>–ü–æ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏</option>
                            <option value="updated_desc" {% if sort == 'updated_desc' %}selected{% endif %}>–ü–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <div class="btn-group w-100">
                            <button type="submit" class="btn btn-admin">
                                <i class="fas fa-search"></i>
                            </button>
                            <a href="/admin/profiles" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                            <button type="button" class="btn btn-outline-info" onclick="toggleProfileFilters()">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                <div class="mt-3" id="profileAdvancedFilters" style="display: none;">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">–¢–∏–ø –ø—Ä–æ—Ñ–∏–ª—è:</label>
                            <select class="form-select" name="profile_type">
                                <option value="">–í—Å–µ</option>
                                <option value="verified">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                                <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ</option>
                                <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                                <option value="public">–ü—É–±–ª–∏—á–Ω—ã–µ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤:</label>
                            <select class="form-select" name="followers_range">
                                <option value="">–í—Å–µ</option>
                                <option value="0-1000">–î–æ 1K</option>
                                <option value="1000-10000">1K - 10K</option>
                                <option value="10000-100000">10K - 100K</option>
                                <option value="100000+">100K+</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞:</label>
                            <select class="form-select" name="success_rate">
                                <option value="">–í—Å–µ</option>
                                <option value="90-100">90-100%</option>
                                <option value="70-90">70-90%</option>
                                <option value="50-70">50-70%</option>
                                <option value="0-50">–ú–µ–Ω–µ–µ 50%</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–ü–µ—Ä–∏–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è:</label>
                            <select class="form-select" name="created_period">
                                <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                                <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                                <option value="week">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</option>
                                <option value="month">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card metric-card">
            <div class="card-body text-center p-3">
                <div class="metric-value" style="font-size: 1.8rem;">{{ profiles|length }}</div>
                <div class="metric-label" style="font-size: 0.8rem;">–ü–æ–∫–∞–∑–∞–Ω–æ</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card metric-card">
            <div class="card-body text-center p-3">
                <div class="metric-value" style="font-size: 1.8rem;">{{ profiles|selectattr("profile.parsing_status", "equalto", "completed")|list|length }}</div>
                <div class="metric-label" style="font-size: 0.8rem;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card metric-card">
            <div class="card-body text-center p-3">
                <div class="metric-value" style="font-size: 1.8rem;">{{ profiles|selectattr("profile.parsing_status", "equalto", "processing")|list|length }}</div>
                <div class="metric-label" style="font-size: 0.8rem;">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card metric-card">
            <div class="card-body text-center p-3">
                <div class="metric-value" style="font-size: 1.8rem;">{{ profiles|sum(attribute="profile.followers_count") }}</div>
                <div class="metric-label" style="font-size: 0.8rem;">–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card metric-card">
            <div class="card-body text-center p-3">
                <div class="metric-value" style="font-size: 1.8rem;">{{ profiles|sum(attribute="followers_saved") }}</div>
                <div class="metric-label" style="font-size: 0.8rem;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card metric-card">
            <div class="card-body text-center p-3">
                <div class="metric-value" style="font-size: 1.8rem;">{{ "%.1f"|format((profiles|sum(attribute="success_rate") / (profiles|length or 1))) }}%</div>
                <div class="metric-label" style="font-size: 0.8rem;">–°—Ä–µ–¥–Ω–∏–π —É—Å–ø–µ—Ö</div>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π -->
<div class="table-container">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-search"></i> –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã</h5>
        <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" onclick="exportProfiles()">
                <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="refreshProfiles()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table mb-0" id="profilesTable">
            <thead>
                <tr>
                    <th width="20%">–ü—Ä–æ—Ñ–∏–ª—å</th>
                    <th width="10%">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</th>
                    <th width="10%">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</th>
                    <th width="10%">–£—Å–ø–µ—Ö</th>
                    <th width="15%">–°—Ç–∞—Ç—É—Å</th>
                    <th width="15%">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th width="10%">–ü–æ—Å—Ç—ã</th>
                    <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for profile_data in profiles %}
                <tr data-profile-id="{{ profile_data.profile.id }}" style="cursor: pointer;" 
                    onclick="showProfileDetails({{ profile_data.profile.id }})">
                    <td>
                        <div class="d-flex align-items-center">
                            {% if profile_data.profile.profile_pic_url %}
                            <img src="{{ profile_data.profile.profile_pic_url }}" alt="Avatar" 
                                 class="rounded-circle me-2" width="40" height="40" 
                                 onerror="this.src='/static/default-avatar.svg'"
                                 title="URL: {{ profile_data.profile.profile_pic_url }}">
                            {% else %}
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" 
                                 style="width: 40px; height: 40px;"
                                 title="–ù–µ—Ç URL –∞–≤–∞—Ç–∞—Ä–∞">
                                <i class="fas fa-user text-muted"></i>
                            </div>
                            {% endif %}
                            <div>
                                <strong>@{{ profile_data.profile.username }}</strong>
                                {% if profile_data.profile.is_verified %}
                                <i class="fas fa-check-circle text-primary" title="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω"></i>
                                {% endif %}
                                {% if profile_data.profile.is_private %}
                                <i class="fas fa-lock text-warning" title="–ü—Ä–∏–≤–∞—Ç–Ω—ã–π"></i>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ profile_data.profile.full_name or '-' }}</small>
                                {% if profile_data.profile.profile_pic_url %}
                                <br><small class="text-info">üñºÔ∏è –ï—Å—Ç—å –∞–≤–∞—Ç–∞—Ä</small>
                                {% else %}
                                <br><small class="text-warning">‚ùå –ù–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞</small>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>{{ "{:,}".format(profile_data.profile.followers_count or 0) }}</strong>
                        <br>
                        <small class="text-muted">{{ "{:,}".format(profile_data.profile.following_count or 0) }} –ø–æ–¥–ø–∏—Å–æ–∫</small>
                    </td>
                    <td>
                        <span class="badge bg-primary">{{ profile_data.followers_saved }}</span>
                        {% if profile_data.profile.followers_count %}
                        <br>
                        <small class="text-muted">
                            {{ "%.1f"|format(profile_data.followers_saved / profile_data.profile.followers_count * 100) }}%
                        </small>
                        {% endif %}
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar 
                                {% if profile_data.success_rate >= 80 %}bg-success
                                {% elif profile_data.success_rate >= 50 %}bg-warning
                                {% else %}bg-danger{% endif %}" 
                                style="width: {{ profile_data.success_rate }}%;">
                                {{ "%.1f"|format(profile_data.success_rate) }}%
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if profile_data.profile.parsing_status == 'completed' %}
                        <span class="status-badge status-active">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        {% elif profile_data.profile.parsing_status == 'processing' %}
                        <span class="status-badge status-pending">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                        {% elif profile_data.profile.parsing_status == 'pending' %}
                        <span class="status-badge status-pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                        {% elif profile_data.profile.parsing_status == 'failed' %}
                        <span class="status-badge status-failed">–û—à–∏–±–∫–∞</span>
                        {% else %}
                        <span class="status-badge">{{ profile_data.profile.parsing_status }}</span>
                        {% endif %}
                        
                        {% if profile_data.profile.parse_task_id %}
                        <br><small class="text-muted">Task: {{ profile_data.profile.parse_task_id[:8] }}...</small>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">
                            {{ profile_data.profile.created_at.strftime('%d.%m.%Y %H:%M') if profile_data.profile.created_at else '-' }}
                        </small>
                        {% if profile_data.profile.last_scraped %}
                        <br>
                        <small class="text-muted">–û–±–Ω–æ–≤–ª–µ–Ω: {{ profile_data.profile.last_scraped.strftime('%d.%m.%Y') }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-info">{{ profile_data.profile.posts_count or 0 }}</span>
                        {% if profile_data.profile.comments_data %}
                        <br><small class="text-success">{{ profile_data.profile.comments_data|length }} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</small>
                        {% endif %}
                    </td>
                    <td onclick="event.stopPropagation();">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="showProfileDetails({{ profile_data.profile.id }})" 
                                    title="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if profile_data.profile.parsing_status in ['failed', 'completed'] %}
                            <button class="btn btn-outline-warning" onclick="reparseProfile({{ profile_data.profile.id }})" 
                                    title="–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥">
                                <i class="fas fa-redo"></i>
                            </button>
                            {% endif %}
                            <a class="btn btn-outline-success" href="https://instagram.com/{{ profile_data.profile.username }}" 
                               target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Instagram">
                                <i class="fab fa-instagram"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                
                {% if not profiles %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-search fa-3x mb-3 d-block"></i>
                        –ü—Ä–æ—Ñ–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <div class="p-3 border-top bg-light">
        <div class="row align-items-center">
            <div class="col-md-5">
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3">
                        –ü–æ–∫–∞–∑–∞–Ω–æ {{ ((current_page - 1) * 30 + 1) }}-{{ min(current_page * 30, profiles|length + (current_page - 1) * 30) }} 
                        –∏–∑ {{ total_pages * 30 }} –ø—Ä–æ—Ñ–∏–ª–µ–π
                    </span>
                    
                    <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                    <div class="btn-group btn-group-sm ms-3">
                        <a href="?status=completed" class="btn btn-outline-success btn-sm" title="–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ">
                            <i class="fas fa-check"></i>
                        </a>
                        <a href="?status=processing" class="btn btn-outline-warning btn-sm" title="–í –ø—Ä–æ—Ü–µ—Å—Å–µ">
                            <i class="fas fa-spinner"></i>
                        </a>
                        <a href="?status=failed" class="btn btn-outline-danger btn-sm" title="–û—à–∏–±–∫–∏">
                            <i class="fas fa-times"></i>
                        </a>
                        <a href="/admin/profiles" class="btn btn-outline-secondary btn-sm" title="–í—Å–µ">
                            <i class="fas fa-list"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 text-center">
                <nav>
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page > 3 %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{{ '&search=' + search if search }}{{ '&status=' + status if status }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}" title="–ü–µ—Ä–≤–∞—è">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ current_page - 1 }}{{ '&search=' + search if search }}{{ '&status=' + status if status }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
                        {% for page_num in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
                        {% if page_num == current_page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_num }}{{ '&search=' + search if search }}{{ '&status=' + status if status }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}">{{ page_num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ current_page + 1 }}{{ '&search=' + search if search }}{{ '&status=' + status if status }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page < total_pages - 2 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ total_pages }}{{ '&search=' + search if search }}{{ '&status=' + status if status }}{{ '&page_size=' + page_size|string }}{{ '&sort=' + sort }}" title="–ü–æ—Å–ª–µ–¥–Ω—è—è">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            
            <div class="col-md-3 text-end">
                <div class="input-group input-group-sm" style="width: 120px; margin-left: auto;">
                    <span class="input-group-text">–°—Ç—Ä.</span>
                    <input type="number" class="form-control" min="1" max="{{ total_pages }}" 
                           value="{{ current_page }}" onchange="goToProfilePage(this.value)">
                    <span class="input-group-text">–∏–∑ {{ total_pages }}</span>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="mt-2">
            <div class="progress" style="height: 3px;">
                <div class="progress-bar bg-success" style="width: {{ (current_page / total_pages * 100) }}%;"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è -->
<div class="modal fade" id="profileDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user"></i> –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="profileDetailsContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è
    async function showProfileDetails(profileId) {
        const modal = new bootstrap.Modal(document.getElementById('profileDetailsModal'));
        modal.show();
        
        try {
            const response = await fetch(`/admin/profiles/${profileId}/details`);
            const data = await response.json();
            
            document.getElementById('profileDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-user"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    ${data.profile.profile_pic_url ? 
                                        `<img src="${data.profile.profile_pic_url}" class="rounded-circle" width="80" height="80" onerror="this.src='/static/default-avatar.svg'">` :
                                        '<div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px;"><i class="fas fa-user fa-2x text-muted"></i></div>'
                                    }
                                </div>
                                <h5 class="text-center">@${data.profile.username}</h5>
                                <p class="text-center text-muted">${data.profile.full_name || '-'}</p>
                                
                                <hr>
                                
                                <div class="row text-center">
                                    <div class="col-4">
                                        <strong>${data.profile.posts_count || 0}</strong>
                                        <br><small>–ü–æ—Å—Ç—ã</small>
                                    </div>
                                    <div class="col-4">
                                        <strong>${data.profile.followers_count?.toLocaleString() || 0}</strong>
                                        <br><small>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</small>
                                    </div>
                                    <div class="col-4">
                                        <strong>${data.profile.following_count?.toLocaleString() || 0}</strong>
                                        <br><small>–ü–æ–¥–ø–∏—Å–∫–∏</small>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <p><strong>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è:</strong></p>
                                <p class="small">${data.profile.biography || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                                
                                ${data.profile.external_url ? `<p><strong>–°—Å—ã–ª–∫–∞:</strong> <a href="${data.profile.external_url}" target="_blank">${data.profile.external_url}</a></p>` : ''}
                                
                                <div class="d-flex gap-2 flex-wrap">
                                    ${data.profile.is_verified ? '<span class="badge bg-primary">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span>' : ''}
                                    ${data.profile.is_private ? '<span class="badge bg-warning">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</span>' : ''}
                                    ${data.profile.is_business ? '<span class="badge bg-info">–ë–∏–∑–Ω–µ—Å</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                    <span class="status-badge ${
                                        data.profile.parsing_status === 'completed' ? 'status-active' :
                                        data.profile.parsing_status === 'processing' ? 'status-pending' :
                                        data.profile.parsing_status === 'failed' ? 'status-failed' : ''
                                    }">${data.profile.parsing_status}</span>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:</strong> ${data.followers_count}
                                </div>
                                
                                <div class="mb-3">
                                    <strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(data.profile.created_at).toLocaleString('ru')}
                                </div>
                                
                                ${data.profile.last_scraped ? 
                                    `<div class="mb-3"><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> ${new Date(data.profile.last_scraped).toLocaleString('ru')}</div>` : ''
                                }
                                
                                ${data.profile.parse_task_id ? 
                                    `<div class="mb-3"><strong>Task ID:</strong> <code>${data.profile.parse_task_id}</code></div>` : ''
                                }
                                
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" style="width: ${(data.followers_count / (data.profile.followers_count || 1) * 100)}%"></div>
                                </div>
                                <small class="text-muted">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞: ${((data.followers_count / (data.profile.followers_count || 1)) * 100).toFixed(1)}%</small>
                            </div>
                        </div>
                        
                        ${data.profile.comments_data && data.profile.comments_data.length > 0 ? `
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6><i class="fas fa-comments"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${data.profile.comments_data.length})</h6>
                            </div>
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                ${data.profile.comments_data.slice(0, 5).map(comment => `
                                    <div class="border-bottom pb-2 mb-2">
                                        <strong>@${comment.username}:</strong>
                                        <p class="small mb-0">${comment.text}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-users"></i> –í–∑–∞–∏–º–Ω—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                ${data.mutual_followers && data.mutual_followers.length > 0 ? 
                                    data.mutual_followers.map(follower => `
                                        <div class="d-flex align-items-center mb-2">
                                            ${follower.profile_pic_url ? 
                                                `<img src="${follower.profile_pic_url}" class="rounded-circle me-2" width="30" height="30" onerror="this.src='/static/default-avatar.svg'">` :
                                                '<div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;"><i class="fas fa-user text-muted"></i></div>'
                                            }
                                            <div>
                                                <strong>@${follower.username}</strong>
                                                <br><small class="text-muted">${follower.full_name || ''}</small>
                                            </div>
                                        </div>
                                    `).join('') :
                                    '<p class="text-muted">–í–∑–∞–∏–º–Ω—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            document.getElementById('profileDetailsContent').innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è</p>
                </div>
            `;
        }
    }

    // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
    async function reparseProfile(profileId) {
        if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —ç—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è?')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/profiles/${profileId}/reparse`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞', 'danger');
        }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π
    function exportProfiles() {
        window.open('/admin/profiles/export?' + new URLSearchParams(window.location.search), '_blank');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    function refreshProfiles() {
        location.reload();
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª–µ–π
    function goToProfilePage(pageNum) {
        if (pageNum < 1 || pageNum > {{ total_pages }}) {
            showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'warning');
            return;
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page', pageNum);
        window.location.search = urlParams.toString();
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–æ—Ñ–∏–ª–µ–π
    function toggleProfileFilters() {
        const filters = document.getElementById('profileAdvancedFilters');
        const button = event.target.closest('button');
        
        if (filters.style.display === 'none' || filters.style.display === '') {
            filters.style.display = 'block';
            button.innerHTML = '<i class="fas fa-filter-circle-xmark"></i>';
            button.classList.remove('btn-outline-info');
            button.classList.add('btn-info');
        } else {
            filters.style.display = 'none';
            button.innerHTML = '<i class="fas fa-filter"></i>';
            button.classList.remove('btn-info');
            button.classList.add('btn-outline-info');
        }
    }
    
    // –ñ–∏–≤–æ–π –ø–æ–∏—Å–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    let profileSearchTimeout;
    document.getElementById('profileSearchInput').addEventListener('input', function() {
        clearTimeout(profileSearchTimeout);
        profileSearchTimeout = setTimeout(() => {
            if (this.value.length >= 2 || this.value.length === 0) {
                document.getElementById('profileSearchForm').submit();
            }
        }, 750);
    });
    
    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
            return;
        }
        
        const currentPage = {{ current_page }};
        const totalPages = {{ total_pages }};
        
        // Shift + —Å—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if (e.shiftKey) {
            if (e.key === 'ArrowLeft' && currentPage > 1) {
                goToProfilePage(currentPage - 1);
            } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
                goToProfilePage(currentPage + 1);
            }
        }
        
        // –¶–∏—Ñ—Ä–æ–≤—ã–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        if (e.ctrlKey) {
            switch(e.key) {
                case '1':
                    window.location.href = '?status=completed';
                    break;
                case '2':
                    window.location.href = '?status=processing';
                    break;
                case '3':
                    window.location.href = '?status=failed';
                    break;
                case '0':
                    window.location.href = '/admin/profiles';
                    break;
            }
        }
    });
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
    let lastRefreshTime = Date.now();
    setInterval(() => {
        if (autoRefresh) {
            const processingRows = document.querySelectorAll('tr[data-profile-id]');
            let hasProcessing = false;
            
            processingRows.forEach(row => {
                if (row.textContent.includes('–ø—Ä–æ—Ü–µ—Å—Å–µ') || row.textContent.includes('–û–∂–∏–¥–∞–Ω–∏–µ')) {
                    hasProcessing = true;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
            if (hasProcessing && Date.now() - lastRefreshTime > 15000) {
                refreshProfiles();
                lastRefreshTime = Date.now();
            }
        }
    }, 10000);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—É–ª—É—á—à–∞–µ—Ç UX)
    function preloadNextPage() {
        const currentPage = {{ current_page }};
        const totalPages = {{ total_pages }};
        
        if (currentPage < totalPages) {
            const nextPageUrl = '?page=' + (currentPage + 1) + window.location.search.substring(1).replace(/page=\d+/, '');
            
            // –°–æ–∑–¥–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–π iframe –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
            const preloadFrame = document.createElement('iframe');
            preloadFrame.style.display = 'none';
            preloadFrame.src = nextPageUrl;
            document.body.appendChild(preloadFrame);
            
            setTimeout(() => {
                document.body.removeChild(preloadFrame);
            }, 5000);
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(preloadNextPage, 3000);
</script>
{% endblock %}
